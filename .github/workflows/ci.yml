name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  validate:
    name: Validate skill
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x

      - name: Validate SKILL.md frontmatter
        run: |
          set -euo pipefail
          echo "Checking SKILL.md exists..."
          test -f SKILL.md || { echo "SKILL.md not found"; exit 1; }

          echo "Checking frontmatter..."
          python3 -c "
          import yaml, sys
          with open('SKILL.md') as f:
              content = f.read()
          parts = content.split('---', 2)
          if len(parts) < 3:
              print('ERROR: No YAML frontmatter found')
              sys.exit(1)
          data = yaml.safe_load(parts[1])
          required = ['name', 'description']
          for key in required:
              if key not in data:
                  print(f'ERROR: Missing required field: {key}')
                  sys.exit(1)
          meta = data.get('metadata', {}).get('openclaw', {})
          if 'requires' not in meta:
              print('WARNING: No requires in metadata.openclaw')
          if 'securityNotes' not in meta:
              print('WARNING: No securityNotes in metadata.openclaw')
          print(f'✓ SKILL.md valid: {data[\"name\"]} — {len(data[\"description\"])} char description')
          print(f'  requires: {meta.get(\"requires\", {}).get(\"bins\", [])}')
          print(f'  install specs: {len(meta.get(\"install\", []))}')
          "

      - name: Validate compositions parse
        run: |
          set -euo pipefail
          echo "Checking composition files..."
          count=0
          for f in assets/compositions/*.js; do
            # Basic syntax check — ensure they're valid JS
            node --check "$f" 2>/dev/null || {
              # Strudel patterns use globals, so --check may fail on undefined refs
              # Just ensure no obvious syntax errors
              node -e "try { require('fs').readFileSync('$f','utf8') } catch(e) { process.exit(1) }"
            }
            count=$((count + 1))
            echo "  ✓ $(basename "$f")"
          done
          echo "✓ $count compositions validated"

      - name: Validate render script
        run: |
          set -euo pipefail
          echo "Checking render script..."
          bash -n scripts/render-pattern.sh
          echo "✓ render-pattern.sh syntax valid"

          echo "Checking STRUDEL_URL support..."
          grep -q 'STRUDEL_URL' scripts/render-pattern.sh || {
            echo "ERROR: render-pattern.sh missing STRUDEL_URL support"
            exit 1
          }
          echo "✓ STRUDEL_URL env var supported"

      - name: Check references
        run: |
          set -euo pipefail
          for f in references/*.md; do
            test -f "$f" || continue
            lines=$(wc -l < "$f")
            echo "  ✓ $(basename "$f") ($lines lines)"
          done
          echo "✓ All references present"

      - name: Security scan
        run: |
          set -euo pipefail
          echo "Scanning for hardcoded secrets..."
          # Check for common secret patterns
          if grep -rn --include="*.js" --include="*.sh" --include="*.md" \
            -E "(DISCORD_TOKEN|BOT_TOKEN|sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|clh_)" \
            . 2>/dev/null; then
            echo "ERROR: Potential secrets detected!"
            exit 1
          fi
          echo "✓ No hardcoded secrets found"

          echo "Scanning for hardcoded paths..."
          if grep -rn --include="*.js" --include="*.sh" \
            -E "/home/[a-z]+/|/Users/[a-z]+/" \
            . 2>/dev/null; then
            echo "WARNING: Hardcoded home paths detected"
          fi
          echo "✓ Security scan passed"

  publish:
    name: Publish to ClaHub
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x

      - name: Extract version
        id: version
        run: |
          # Use git tags for semver, fall back to 0.x.0-dev+sha
          VERSION=$(git describe --tags --match 'v*' --always 2>/dev/null || echo "")
          if [[ "$VERSION" =~ ^v ]]; then
            VERSION="${VERSION#v}"
          else
            # No tag — use commit count as patch version
            COUNT=$(git rev-list --count HEAD)
            SHA=$(git rev-parse --short HEAD)
            VERSION="0.${COUNT}.0-dev+${SHA}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Publishing version: $VERSION"

      - name: Configure ClaHub auth
        env:
          CLAWHUB_CLI_TOKEN: ${{ secrets.CLAWHUB_CLI_TOKEN }}
        run: |
          mkdir -p ~/.config/clawhub
          echo "{\"registry\":\"https://clawhub.ai\",\"token\":\"${CLAWHUB_CLI_TOKEN}\"}" \
            > ~/.config/clawhub/config.json

      - name: Publish to ClaHub
        run: |
          npx clawhub publish \
            --slug strudel-music \
            --version "${{ steps.version.outputs.version }}" \
            .
