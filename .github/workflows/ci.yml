name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  test:
    name: Smoke test + render
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Download samples
        run: bash scripts/download-samples.sh

      - name: Smoke test (12 checks)
        run: npm test

      - name: Render test (fog-and-starlight)
        run: npm run test:render

      - name: Render all compositions
        run: |
          set -euo pipefail
          for f in assets/compositions/*.js; do
            name=$(basename "$f" .js)
            echo "=== Rendering $name ==="
            node src/runtime/offline-render-v2.mjs "$f" "/tmp/${name}.wav" 2 120 2>&1 | grep -E "haps|Scheduled|✅|❌"
          done

  validate:
    name: Validate skill metadata
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate SKILL.md frontmatter
        run: |
          set -euo pipefail
          test -f SKILL.md || { echo "❌ SKILL.md not found"; exit 1; }
          python3 -c "
          import yaml, sys, json
          with open('SKILL.md') as f:
              content = f.read()
          parts = content.split('---', 2)
          if len(parts) < 3:
              print('❌ No YAML frontmatter'); sys.exit(1)
          data = yaml.safe_load(parts[1])
          for key in ['name', 'description']:
              if key not in data:
                  print(f'❌ Missing: {key}'); sys.exit(1)
          meta = data.get('metadata', {})
          if isinstance(meta, str):
              meta = json.loads(meta)
          oc = meta.get('openclaw', {})
          print(f'✅ {data[\"name\"]} — user-invocable: {data.get(\"user-invocable\", False)}')
          print(f'   requires: {oc.get(\"requires\", {}).get(\"bins\", [])}')
          print(f'   install steps: {len(oc.get(\"install\", []))}')
          print(f'   security notes: {\"yes\" if oc.get(\"securityNotes\") else \"no\"}')
          "

      - name: Validate compositions syntax
        run: |
          set -euo pipefail
          count=0
          for f in assets/compositions/*.js; do
            node -e "require('fs').readFileSync('$f', 'utf8')" 2>/dev/null
            count=$((count + 1))
          done
          echo "✅ $count compositions readable"

      - name: Check references
        run: |
          set -euo pipefail
          for f in references/*.md; do
            [ -f "$f" ] || continue
            echo "  ✅ $(basename "$f") ($(wc -l < "$f") lines)"
          done

  security:
    name: Security scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Scan for hardcoded secrets
        run: |
          set -euo pipefail
          if grep -rn --include="*.js" --include="*.sh" --include="*.mjs" \
            -E "(DISCORD_TOKEN|BOT_TOKEN|sk-[a-zA-Z0-9]{20,}|ghp_[a-zA-Z0-9]{36}|clh_)" \
            . 2>/dev/null | grep -v node_modules | grep -v '.git'; then
            echo "❌ Potential secrets detected!"
            exit 1
          fi
          echo "✅ No secrets"

      - name: Scan for hardcoded paths
        run: |
          if grep -rn --include="*.js" --include="*.sh" --include="*.mjs" \
            -E "/home/[a-z]+/|/Users/[a-z]+/" \
            . 2>/dev/null | grep -v node_modules | grep -v '.git'; then
            echo "⚠️ Hardcoded home paths (non-blocking)"
          fi
          echo "✅ Path scan done"

  publish:
    name: Publish to ClaHub
    needs: [test, validate, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x

      - name: Extract version
        id: version
        run: |
          VERSION=$(git describe --tags --match 'v*' --always 2>/dev/null || echo "")
          if [[ "$VERSION" =~ ^v ]]; then
            VERSION="${VERSION#v}"
          else
            COUNT=$(git rev-list --count HEAD)
            SHA=$(git rev-parse --short HEAD)
            VERSION="0.${COUNT}.0-dev+${SHA}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Publishing version: $VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Authenticate with ClaHub
        env:
          CLAWHUB_CLI_TOKEN: ${{ secrets.CLAWHUB_CLI_TOKEN }}
        run: |
          npx clawhub login --token "$CLAWHUB_CLI_TOKEN" --no-browser
          npx clawhub whoami

      - name: Publish to ClaHub
        run: |
          npx clawhub publish \
            --slug strudel-music \
            --version "${{ steps.version.outputs.version }}" \
            "$(pwd)"
